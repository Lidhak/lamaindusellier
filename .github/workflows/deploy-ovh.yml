name: Deploy OVH Web Cloud

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-ovh-webcloud-lamaindusellier
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy via SFTP
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    timeout-minutes: 15
    env:
      OVH_SFTP_HOST: ftp.cluster121.hosting.ovh.net
      OVH_SFTP_PORT: "22"
      OVH_SFTP_USER: lamainn
      OVH_REMOTE_DIR: www
      OVH_SFTP_PASSWORD: ${{ secrets.OVH_SFTP_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          test -n "$OVH_SFTP_PASSWORD" || (echo "Missing OVH_SFTP_PASSWORD secret" && exit 1)

      - name: Prepare deploy bundle
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/assets
          cp index.html dist/index.html
          cp realisations.html dist/realisations.html
          cp contact.php dist/contact.php
          cp -R assets/. dist/assets/

      - name: Install lftp
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Upload to OVH SFTP
        run: |
          set -euo pipefail
          lftp -u "$OVH_SFTP_USER","$OVH_SFTP_PASSWORD" "sftp://$OVH_SFTP_HOST:$OVH_SFTP_PORT" -e "set cmd:fail-exit yes; set sftp:auto-confirm yes; set net:timeout 20; set net:max-retries 2; mirror -R --delete --verbose ./dist/ $OVH_REMOTE_DIR; bye"

      - name: Post-deploy check
        run: |
          set -euo pipefail
          curl -fsS https://lamaindusellier.fr >/dev/null
